<script>
import { inject } from "vue";
import BaseResource from "../BaseResource.vue";
import { storeToRefs } from "pinia";
import { APIClient } from "../../fetch/api-client.js";

export default {
    extends: BaseResource,
    props: {
        routeAction: String,
    },
    setup(props) {
        const AVStore = inject("AVStore");
        const { av_license_types, av_license_statuses, av_user_roles } =
            storeToRefs(AVStore);

        const vendorStore = inject("vendorStore");
        const { vendors } = storeToRefs(vendorStore);

        return {
            ...BaseResource.setup({
                resourceName: "license",
                nameAttr: "name",
                idAttr: "license_id",
                showComponent: "LicensesShow",
                listComponent: "LicensesList",
                addComponent: "LicensesFormAdd",
                editComponent: "LicensesFormAddEdit",
                apiClient: APIClient.erm.licenses,
                resourceTableUrl:
                    APIClient.erm.httpClient._baseURL + "licenses",
                i18n: {
                    deleteConfirmationMessage: __(
                        "Are you sure you want to remove this license?"
                    ),
                    deleteSuccessMessage: __("License %s deleted"),
                    displayName: __("License"),
                    editLabel: __("Edit license #%s"),
                    emptyListMessage: __("There are no licenses defined"),
                    newLabel: __("New license"),
                },
                extendedAttributesResourceType: "license",
                av_license_types,
                av_license_statuses,
                av_user_roles,
                license_table_settings,
                vendors,
            }),
        };
    },
    data() {
        const tableFilters = this.getTableFilterFormElements();
        const defaults = this.getFilterValues(this.$route.query, tableFilters);

        return {
            resourceAttrs: [
                {
                    name: this.idAttr,
                    label: this.$__("ID"),
                    type: "text",
                    hideIn: ["Form", "Show"],
                },
                {
                    name: "name",
                    required: true,
                    type: "text",
                    label: this.$__("License name"),
                },
                {
                    name: "vendor_id",
                    type: "vendor",
                    label: this.$__("Vendor"),
                    showElement: {
                        type: "text",
                        value: "vendor.name",
                        link: {
                            href: "/cgi-bin/koha/acqui/supplier.pl",
                            params: {
                                bookseller_id: "vendor_id",
                            },
                        },
                    },
                },
                {
                    name: "description",
                    type: "textarea",
                    label: this.$__("Description"),
                    required: true,
                },
                {
                    name: "type",
                    required: true,
                    type: "select",
                    label: this.$__("Type"),
                    avCat: "av_license_types",
                },
                {
                    name: "status",
                    required: true,
                    type: "select",
                    label: this.$__("Status"),
                    avCat: "av_license_statuses",
                },
                {
                    name: "started_on",
                    type: "date",
                    label: this.$__("Start date"),
                    showElement: {
                        type: "text",
                        value: "started_on",
                        format: this.format_date,
                    },
                    componentProps: {
                        date_to: {
                            type: "string",
                            value: "ended_on",
                        },
                    },
                },
                {
                    name: "ended_on",
                    type: "date",
                    label: this.$__("End date"),
                    showElement: {
                        type: "text",
                        value: "ended_on",
                        format: this.format_date,
                    },
                },
                {
                    name: "user_roles",
                    type: "relationshipWidget",
                    group: this.$__("Users"),
                    showElement: {
                        type: "table",
                        columnData: "user_roles",
                        hidden: license => !!license.user_roles?.length,
                        label: this.$__("License users"),
                        columns: [
                            {
                                name: this.$__("Name"),
                                value: "patron",
                                format: this.patron_to_html,
                            },
                            {
                                name: this.$__("Role"),
                                value: "role",
                                av: "av_user_roles",
                            },
                        ],
                    },
                    componentProps: {
                        resourceRelationships: {
                            resourceProperty: "user_roles",
                        },
                        relationshipStrings: {
                            nameLowerCase: this.$__("user"),
                            nameUpperCase: this.$__("License user"),
                            namePlural: this.$__("users"),
                        },
                        newRelationshipDefaultAttrs: {
                            type: "object",
                            value: {
                                user_id: null,
                                role: null,
                                patron_str: "",
                            },
                        },
                    },
                    relationshipFields: [
                        {
                            name: "user_id",
                            type: "component",
                            label: this.$__("User"),
                            componentPath: "./PatronSearch.vue",
                            required: true,
                            indexRequired: true,
                            componentProps: {
                                name: {
                                    type: "string",
                                    value: "user_id",
                                },
                                required: {
                                    type: "boolean",
                                    value: true,
                                },
                                resource: {
                                    type: "resource",
                                    value: null,
                                },
                                label: {
                                    type: "string",
                                    value: this.$__("User"),
                                },
                            },
                        },
                        {
                            name: "role",
                            type: "select",
                            label: this.$__("Role"),
                            avCat: "av_user_roles",
                            required: true,
                            indexRequired: true,
                        },
                    ],
                    hideIn: ["List"],
                },
                {
                    name: "documents",
                    type: "relationshipWidget",
                    group: this.$__("Documents"),
                    showElement: {
                        type: "component",
                        hidden: license => !!license.documents?.length,
                        componentPath: "./DocumentDisplay.vue",
                        componentProps: {
                            resource: {
                                type: "resource",
                                value: null,
                            },
                        },
                    },
                    componentProps: {
                        resourceRelationships: {
                            resourceProperty: "documents",
                        },
                        relationshipStrings: {
                            nameLowerCase: this.$__("document"),
                            nameUpperCase: this.$__("Document"),
                            namePlural: this.$__("documents"),
                        },
                        newRelationshipDefaultAttrs: {
                            type: "object",
                            value: {
                                file_name: null,
                                file_type: null,
                                file_description: null,
                                file_content: null,
                                physical_location: null,
                                uri: null,
                                notes: null,
                            },
                        },
                    },
                    relationshipFields: [
                        {
                            name: "document",
                            type: "component",
                            componentPath: "./DocumentSelect.vue",
                            label: this.$__("File"),
                            componentProps: {
                                counter: {
                                    type: "string",
                                    value: "",
                                    indexRequired: true,
                                },
                                document: {
                                    type: "resource",
                                    value: null,
                                },
                            },
                        },
                        {
                            name: "physical_location",
                            required: false,
                            type: "text",
                            label: this.$__("Physical location"),
                            indexRequired: true,
                        },
                        {
                            name: "uri",
                            required: false,
                            type: "text",
                            label: this.$__("URI"),
                            indexRequired: true,
                        },
                        {
                            name: "notes",
                            required: false,
                            type: "text",
                            label: this.$__("Notes"),
                            indexRequired: true,
                        },
                    ],
                    hideIn: ["List"],
                },
            ],
            tableOptions: {
                url: this.getResourceTableUrl(),
                options: { embed: "vendor,extended_attributes,+strings" },
                table_settings: this.license_table_settings,
                add_filters: true,
                filters_options: {
                    2: () =>
                        this.vendors.map(e => {
                            e["_id"] = e["id"];
                            e["_str"] = e["name"];
                            return e;
                        }),
                    4: () => this.map_av_dt_filter("av_license_types"),
                    5: () => this.map_av_dt_filter("av_license_statuses"),
                },
                actions: {
                    0: ["show"],
                    1: ["show"],
                    "-1": ["edit", "delete"],
                },
            },
            tableFilters,
        };
    },
    methods: {
        checkForm(license) {
            let errors = [];

            let documents_with_uploaded_files = license.documents.filter(
                doc => typeof doc.file_content !== "undefined"
            );
            if (
                documents_with_uploaded_files.filter(
                    doc => atob(doc.file_content).length >= max_allowed_packet
                ).length >= 1
            ) {
                errors.push(
                    this.$__("File size exceeds maximum allowed: %s MB").format(
                        (max_allowed_packet / (1024 * 1024)).toFixed(2)
                    )
                );
            }
            license.user_roles.forEach((user, i) => {
                if (user.patron_str === "") {
                    errors.push(
                        this.$__("License user %s is missing a user").format(
                            i + 1
                        )
                    );
                }
            });
            this.setWarning(errors.join("<br>"));
            return !errors.length;
        },
        onSubmit(e, licenseToSave) {
            e.preventDefault();

            let license = JSON.parse(JSON.stringify(licenseToSave)); // copy
            let license_id = license.license_id;

            if (!this.checkForm(license)) {
                return false;
            }

            delete license.license_id;
            delete license.vendor;
            delete license._strings;

            if (license.vendor_id == "") {
                license.vendor_id = null;
            }

            license.user_roles = license.user_roles.map(
                ({ patron, patron_str, ...keepAttrs }) => keepAttrs
            );

            license.documents = license.documents.map(
                ({ file_type, uploaded_on, ...keepAttrs }) => keepAttrs
            );

            if (license_id) {
                this.apiClient.update(license, license_id).then(
                    success => {
                        this.setMessage(this.$__("License updated"));
                        this.$router.push({ name: "LicensesList" });
                    },
                    error => {}
                );
            } else {
                this.apiClient.create(license).then(
                    success => {
                        this.setMessage(this.$__("License created"));
                        this.$router.push({ name: "LicensesList" });
                    },
                    error => {}
                );
            }
        },
    },
    name: "LicenseResource",
};
</script>
